# Tox configuration file
# Read more under https://tox.wiki/
# THIS SCRIPT IS SUPPOSED TO BE AN EXAMPLE. MODIFY IT ACCORDING TO YOUR NEEDS!

[tox]
minversion = 3.24
envlist = test, publish
isolated_build = True

[testenv]
allowlist_externals =
    aws



#
[testenv:dev]
description = Constroi ambiente de desenvolvimento
skip_install = True
deps =
passenv =
    HOME
    SETUPTOOLS_*
    AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY
commands =
    python -m venv {toxworkdir}/venv
    # adicione lógica para pegar credenciais do pip de seu repositório privado
    pip install -r requirements.txt



#
[testenv:test]
description = Executa os testes unitários do container que será publicado. O código deve 
              possuir os testes implementados com pytest, para que a imagem possa ser 
              chamada no Docker Desktop para teste.
setenv =
    TOXINIDIR = {toxinidir}
passenv =
    HOME
    SETUPTOOLS_*
extras =
    testing
commands =
    pytest --docker tests/



#
[testenv:publish]
description = 
    Publica o novo pacote imagem do container no ECR seguindo o padrão 
    '<image-name>:<tag-version/latest>'
skip_install = True
changedir = {toxinidir}
passenv =
    # See: https://twine.readthedocs.io/en/latest/
    TWINE_USERNAME
    TWINE_PASSWORD
    TWINE_REPOSITORY
    TWINE_REPOSITORY_URL
deps = twine
commands =
    # adicione lógica para pegar credenciais do twine de seu repositório privado
    python -m twine check dist/*
    python -m twine upload {posargs:--repository {env:TWINE_REPOSITORY:testpypi}} dist/*
